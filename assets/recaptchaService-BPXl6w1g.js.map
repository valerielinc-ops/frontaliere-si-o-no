{"version":3,"file":"recaptchaService-BPXl6w1g.js","sources":["../../services/recaptchaService.ts"],"sourcesContent":["/**\n * reCAPTCHA Enterprise Service\n * Protegge le API a consumo da abusi e bot\n */\n\n// Estendi il tipo Window per includere grecaptcha\ndeclare global {\n  interface Window {\n    grecaptcha?: {\n      enterprise: {\n        ready: (callback: () => void) => void;\n        execute: (siteKey: string, options: { action: string }) => Promise<string>;\n      };\n    };\n  }\n}\n\nexport type RecaptchaAction = \n  | 'TRAFFIC_DATA'      // Richiesta dati traffico Google Maps\n  | 'EXCHANGE_RATES'    // Richiesta tassi di cambio\n  | 'FEEDBACK_SUBMIT'   // Invio feedback\n  | 'API_TEST'          // Test API\n  | 'PAGE_LOAD';        // Caricamento pagina\n\nclass RecaptchaService {\n  private siteKey: string | null = null;\n  private isReady: boolean = false;\n\n  constructor() {\n    // Site key loaded dynamically from Firebase Remote Config, not from env\n    this.siteKey = null;\n    \n    // Attendi che reCAPTCHA sia pronto\n    if (this.isEnabled() && typeof window !== 'undefined') {\n      this.waitForRecaptcha();\n    }\n  }\n\n  /**\n   * Controlla se reCAPTCHA è configurato\n   */\n  public isEnabled(): boolean {\n    return this.siteKey !== null && this.siteKey.length > 0;\n  }\n\n  /**\n   * Attende che lo script reCAPTCHA sia caricato\n   */\n  private async waitForRecaptcha(): Promise<void> {\n    return new Promise((resolve) => {\n      const checkRecaptcha = () => {\n        if (window.grecaptcha?.enterprise) {\n          window.grecaptcha.enterprise.ready(() => {\n            this.isReady = true;\n            resolve();\n          });\n        } else {\n          // Riprova dopo 100ms\n          setTimeout(checkRecaptcha, 100);\n        }\n      };\n      checkRecaptcha();\n    });\n  }\n\n  /**\n   * Esegue la verifica reCAPTCHA e restituisce il token\n   * @param action L'azione da verificare (es. 'TRAFFIC_DATA', 'EXCHANGE_RATES')\n   * @returns Token reCAPTCHA o null se non disponibile\n   */\n  public async executeRecaptcha(action: RecaptchaAction): Promise<string | null> {\n    // Se reCAPTCHA non è configurato, restituisci null (modalità fallback)\n    if (!this.isEnabled()) {\n      console.warn('reCAPTCHA non configurato - operazione consentita senza verifica');\n      return null;\n    }\n\n    try {\n      // Attendi che reCAPTCHA sia pronto se non lo è ancora\n      if (!this.isReady) {\n        await this.waitForRecaptcha();\n      }\n\n      // Esegui la verifica\n      if (window.grecaptcha?.enterprise && this.siteKey) {\n        const token = await window.grecaptcha.enterprise.execute(this.siteKey, {\n          action: action\n        });\n        \n        console.log(`✅ reCAPTCHA token ottenuto per azione: ${action}`);\n        return token;\n      }\n\n      console.warn('reCAPTCHA non disponibile');\n      return null;\n\n    } catch (error) {\n      console.error('Errore durante l\\'esecuzione di reCAPTCHA:', error);\n      // In caso di errore, permetti comunque l'operazione (graceful degradation)\n      return null;\n    }\n  }\n\n  /**\n   * Verifica se una richiesta può procedere (con o senza token)\n   * Questa funzione può essere estesa per implementare logiche di throttling\n   */\n  public async canProceed(action: RecaptchaAction): Promise<boolean> {\n    // Se reCAPTCHA è abilitato, richiedi il token\n    if (this.isEnabled()) {\n      const token = await this.executeRecaptcha(action);\n      // Anche se il token fallisce, permetti l'operazione (graceful degradation)\n      return true;\n    }\n    \n    // Se reCAPTCHA non è configurato, permetti sempre\n    return true;\n  }\n\n  /**\n   * Ottiene il token reCAPTCHA per una richiesta API\n   * Da inviare al backend per la verifica\n   */\n  public async getTokenForApi(action: RecaptchaAction): Promise<string | null> {\n    return await this.executeRecaptcha(action);\n  }\n}\n\n// Esporta un'istanza singleton\nexport const recaptchaService = new RecaptchaService();\nexport default recaptchaService;\n"],"names":["RecaptchaService","resolve","checkRecaptcha","_a","action","token","error","recaptchaService"],"mappings":"AAwBA,MAAMA,CAAiB,CAIrB,aAAc,CAHd,KAAQ,QAAyB,KACjC,KAAQ,QAAmB,GAIzB,KAAK,QAAU,KAGX,KAAK,UAAA,GAAe,OAAO,OAAW,KACxC,KAAK,iBAAA,CAET,CAKO,WAAqB,CAC1B,OAAO,KAAK,UAAY,MAAQ,KAAK,QAAQ,OAAS,CACxD,CAKA,MAAc,kBAAkC,CAC9C,OAAO,IAAI,QAASC,GAAY,CAC9B,MAAMC,EAAiB,IAAM,CA1BnC,IAAAC,GA2BYA,EAAA,OAAO,aAAP,MAAAA,EAAmB,WACrB,OAAO,WAAW,WAAW,MAAM,IAAM,CACvC,KAAK,QAAU,GACfF,EAAA,CACF,CAAC,EAGD,WAAWC,EAAgB,GAAG,CAElC,EACAA,EAAA,CACF,CAAC,CACH,CAOA,MAAa,iBAAiBE,EAAiD,CA9CjF,IAAAD,EAgDI,GAAI,CAAC,KAAK,YACR,eAAQ,KAAK,kEAAkE,EACxE,KAGT,GAAI,CAOF,GALK,KAAK,SACR,MAAM,KAAK,iBAAA,GAITA,EAAA,OAAO,aAAP,MAAAA,EAAmB,YAAc,KAAK,QAAS,CACjD,MAAME,EAAQ,MAAM,OAAO,WAAW,WAAW,QAAQ,KAAK,QAAS,CACrE,OAAAD,CAAA,CACD,EAED,eAAQ,IAAI,0CAA0CA,CAAM,EAAE,EACvDC,CACT,CAEA,eAAQ,KAAK,2BAA2B,EACjC,IAET,OAASC,EAAO,CACd,eAAQ,MAAM,4CAA8CA,CAAK,EAE1D,IACT,CACF,CAMA,MAAa,WAAWF,EAA2C,CAEjE,OAAI,KAAK,aACO,MAAM,KAAK,iBAAiBA,CAAM,EAEzC,EAKX,CAMA,MAAa,eAAeA,EAAiD,CAC3E,OAAO,MAAM,KAAK,iBAAiBA,CAAM,CAC3C,CACF,CAGO,MAAMG,EAAmB,IAAIP"}