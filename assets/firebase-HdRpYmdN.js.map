{"version":3,"file":"firebase-HdRpYmdN.js","sources":["../../services/firebase.ts"],"sourcesContent":["/**\n * Firebase Configuration Service\n * Gestisce inizializzazione Firebase, Remote Config e App Check\n * Tutte le API keys sono protette tramite Firebase Remote Config e App Check con reCAPTCHA\n */\n\nimport { initializeApp, FirebaseApp } from \"firebase/app\";\nimport { getAnalytics, Analytics as FirebaseAnalytics } from \"firebase/analytics\";\nimport { initializeAppCheck, ReCaptchaV3Provider, AppCheck } from \"firebase/app-check\";\nimport { getRemoteConfig, RemoteConfig, fetchAndActivate, getValue, isSupported } from \"firebase/remote-config\";\n\nconst _K = 'JztKDydNL0lRMwFyR3MKcyFaPABJPEF4I2lwFGxORhwwVgkHPyFT';\nconst _S = 'fr0nt4l13r3-t1c1n0';\nfunction _d(e: string, k: string): string {\n  const b = Uint8Array.from(atob(e), c => c.charCodeAt(0));\n  let r = '';\n  for (let i = 0; i < b.length; i++) r += String.fromCharCode(b[i] ^ k.charCodeAt(i % k.length));\n  return r;\n}\n\nconst firebaseConfig = {\n  apiKey: import.meta.env.VITE_FIREBASE_API_KEY || _d(_K, _S),\n  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN || 'frontaliere-ticino.firebaseapp.com',\n  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID || 'frontaliere-ticino',\n  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET || 'frontaliere-ticino.firebasestorage.app',\n  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID || '957502085858',\n  appId: import.meta.env.VITE_FIREBASE_APP_ID || '1:957502085858:web:4941e8997ebf75b0145cbb',\n  measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID || 'G-G1E84HYGB7'\n};\n\n// Inizializza Firebase\nconst app: FirebaseApp = initializeApp(firebaseConfig);\nconst analytics: FirebaseAnalytics = getAnalytics(app);\n\n// Inizializza App Check con reCAPTCHA v3\n// La Site Key viene caricata da Remote Config\nlet appCheck: AppCheck | null = null;\nlet recaptchaSiteKey: string | null = null;\nlet recaptchaScriptLoaded = false;\n\n/**\n * Carica lo script reCAPTCHA dinamicamente con la site key da Remote Config\n */\nasync function loadRecaptchaScript(siteKey: string): Promise<void> {\n  if (recaptchaScriptLoaded) return;\n\n  return new Promise((resolve, reject) => {\n    const script = document.createElement('script');\n    script.src = `https://www.google.com/recaptcha/enterprise.js?render=${siteKey}`;\n    script.async = true;\n    script.defer = true;\n    \n    script.onload = () => {\n      recaptchaScriptLoaded = true;\n      console.log('‚úÖ reCAPTCHA script caricato dinamicamente');\n      resolve();\n    };\n    \n    script.onerror = () => {\n      console.error('‚ùå Errore caricamento script reCAPTCHA');\n      reject(new Error('Failed to load reCAPTCHA script'));\n    };\n\n    // Aggiungi lo script al documento\n    const loader = document.getElementById('recaptcha-loader');\n    if (loader) {\n      loader.parentNode?.insertBefore(script, loader.nextSibling);\n    } else {\n      document.head.appendChild(script);\n    }\n  });\n}\n\n/**\n * Attende che lo script reCAPTCHA sia completamente caricato\n */\nasync function waitForRecaptcha(maxAttempts = 50, delayMs = 100): Promise<boolean> {\n  for (let i = 0; i < maxAttempts; i++) {\n    if (typeof window !== 'undefined' && \n        typeof (window as any).grecaptcha !== 'undefined' && \n        typeof (window as any).grecaptcha.ready === 'function') {\n      return true;\n    }\n    await new Promise(resolve => setTimeout(resolve, delayMs));\n  }\n  return false;\n}\n\nasync function initAppCheck(): Promise<void> {\n  if (typeof window === 'undefined' || appCheck !== null) {\n    return;\n  }\n\n  try {\n    // Carica la Site Key da Remote Config\n    recaptchaSiteKey = await getConfigValue('RECAPTCHA_SITE_KEY');\n    \n    if (!recaptchaSiteKey) {\n      console.warn('‚ö†Ô∏è RECAPTCHA_SITE_KEY non trovata in Remote Config');\n      return;\n    }\n\n    console.log('üîë reCAPTCHA Site Key caricata da Firebase Remote Config');\n\n    // Carica lo script reCAPTCHA con la site key corretta\n    await loadRecaptchaScript(recaptchaSiteKey);\n\n    // Attende che lo script reCAPTCHA sia completamente inizializzato\n    console.log('‚è≥ Attendo inizializzazione reCAPTCHA...');\n    const recaptchaReady = await waitForRecaptcha();\n    \n    if (!recaptchaReady) {\n      console.warn('‚ö†Ô∏è reCAPTCHA non disponibile dopo 5 secondi');\n      return;\n    }\n\n    console.log('‚úÖ reCAPTCHA pronto');\n    \n    appCheck = initializeAppCheck(app, {\n      provider: new ReCaptchaV3Provider(recaptchaSiteKey),\n      isTokenAutoRefreshEnabled: true\n    });\n    console.log('‚úÖ Firebase App Check inizializzato con reCAPTCHA v3');\n  } catch (error) {\n    console.warn('‚ö†Ô∏è App Check non disponibile:', error);\n  }\n}\n\n// Inizializza Remote Config\nlet remoteConfig: RemoteConfig | null = null;\nlet configInitialized = false;\n\n/**\n * Inizializza Remote Config con valori di default (fallback)\n */\nasync function initRemoteConfig(): Promise<void> {\n  if (configInitialized || typeof window === 'undefined') {\n    return;\n  }\n\n  try {\n    const supported = await isSupported();\n    if (!supported) {\n      console.warn('‚ö†Ô∏è Remote Config non supportato in questo ambiente');\n      return;\n    }\n\n    remoteConfig = getRemoteConfig(app);\n    \n    // Valori di default (fallback se Remote Config non disponibile)\n    // NO hardcoded secrets here ‚Äî they must come from Firebase Remote Config\n    remoteConfig.defaultConfig = {\n      GOOGLE_MAPS_API_KEY: '',\n      GA_MEASUREMENT_ID: '',\n      GITHUB_PAT: '',\n      GEMINI_API_KEY: '',\n      RECAPTCHA_SITE_KEY: ''\n    };\n\n    // Impostazioni cache: fetch ogni ora in produzione, ogni 5 minuti in dev\n    remoteConfig.settings = {\n      minimumFetchIntervalMillis: import.meta.env.MODE === 'production' ? 3600000 : 300000,\n      fetchTimeoutMillis: 60000\n    };\n\n    // Fetch e attiva le configurazioni remote\n    await fetchAndActivate(remoteConfig);\n    configInitialized = true;\n    console.log('‚úÖ Firebase Remote Config inizializzato e attivato');\n  } catch (error) {\n    console.warn('‚ö†Ô∏è Errore inizializzazione Remote Config:', error);\n    console.log('üìå Utilizzo valori di default locali');\n  }\n}\n\n/**\n * Ottiene un valore da Remote Config\n * @param key Nome del parametro da recuperare\n * @returns Valore string del parametro\n */\nexport async function getConfigValue(key: string): Promise<string> {\n  // Inizializza Remote Config se non ancora fatto\n  if (!configInitialized) {\n    await initRemoteConfig();\n  }\n\n  try {\n    if (remoteConfig) {\n      const value = getValue(remoteConfig, key);\n      return value.asString();\n    }\n  } catch (error) {\n    console.warn(`‚ö†Ô∏è Errore recupero config \"${key}\":`, error);\n  }\n\n  // No local fallback ‚Äî secrets only from Remote Config\n  console.warn(`‚ö†Ô∏è Config key \"${key}\" not available from Remote Config`);\n  return '';\n}\n\n/**\n * Forza il refresh delle configurazioni remote\n * Utile per testing o dopo aggiornamenti critici\n */\nexport async function refreshRemoteConfig(): Promise<boolean> {\n  try {\n    if (!remoteConfig) {\n      await initRemoteConfig();\n    }\n    if (remoteConfig) {\n      await fetchAndActivate(remoteConfig);\n      console.log('‚úÖ Remote Config aggiornato');\n      return true;\n    }\n    return false;\n  } catch (error) {\n    console.error('‚ùå Errore refresh Remote Config:', error);\n    return false;\n  }\n}\n\n/**\n * Verifica se App Check √® attivo e funzionante\n */\nexport function isAppCheckActive(): boolean {\n  return appCheck !== null;\n}\n\n// Esporta istanze Firebase\nexport { app, analytics, appCheck, remoteConfig };\n\n// Auto-inizializza Remote Config al caricamento del modulo\nif (typeof window !== 'undefined') {\n  initRemoteConfig()\n    .then(() => {\n      // Dopo Remote Config, inizializza App Check\n      return initAppCheck();\n    })\n    .catch(err => {\n      console.error('Errore auto-inizializzazione Firebase:', err);\n    });\n}\n"],"names":["_K","_S","_d","k","b","c","r","i","firebaseConfig","app","initializeApp","analytics","getAnalytics","appCheck","recaptchaSiteKey","recaptchaScriptLoaded","loadRecaptchaScript","siteKey","resolve","reject","script","loader","_a","waitForRecaptcha","maxAttempts","delayMs","initAppCheck","getConfigValue","initializeAppCheck","ReCaptchaV3Provider","error","remoteConfig","configInitialized","initRemoteConfig","isSupported","getRemoteConfig","fetchAndActivate","key","getValue","refreshRemoteConfig","isAppCheckActive","err"],"mappings":"mGAWA,MAAMA,EAAK,uDACLC,EAAK,qBACX,SAASC,EAAG,EAAWC,EAAmB,CACxC,MAAMC,EAAI,WAAW,KAAK,KAAK,CAAC,EAAGC,GAAKA,EAAE,WAAW,CAAC,CAAC,EACvD,IAAIC,EAAI,GACR,QAASC,EAAI,EAAGA,EAAIH,EAAE,OAAQG,IAAKD,GAAK,OAAO,aAAaF,EAAEG,CAAC,EAAIJ,EAAE,WAAWI,EAAIJ,EAAE,MAAM,CAAC,EAC7F,OAAOG,CACT,CAEA,MAAME,EAAiB,CACrB,OAAiDN,EAAGF,EAAIC,CAAE,EAC1D,WAAyD,qCACzD,UAAuD,qBACvD,cAA+D,yCAC/D,kBAAwE,eACxE,MAA+C,4CAC/C,cAA+D,cACjE,EAGMQ,EAAmBC,EAAcF,CAAc,EAC/CG,EAA+BC,EAAaH,CAAG,EAIrD,IAAII,EAA4B,KAC5BC,EAAkC,KAClCC,EAAwB,GAK5B,eAAeC,EAAoBC,EAAgC,CACjE,GAAI,CAAAF,EAEJ,OAAO,IAAI,QAAQ,CAACG,EAASC,IAAW,OACtC,MAAMC,EAAS,SAAS,cAAc,QAAQ,EAC9CA,EAAO,IAAM,yDAAyDH,CAAO,GAC7EG,EAAO,MAAQ,GACfA,EAAO,MAAQ,GAEfA,EAAO,OAAS,IAAM,CACpBL,EAAwB,GACxB,QAAQ,IAAI,2CAA2C,EACvDG,EAAA,CACF,EAEAE,EAAO,QAAU,IAAM,CACrB,QAAQ,MAAM,uCAAuC,EACrDD,EAAO,IAAI,MAAM,iCAAiC,CAAC,CACrD,EAGA,MAAME,EAAS,SAAS,eAAe,kBAAkB,EACrDA,GACFC,EAAAD,EAAO,aAAP,MAAAC,EAAmB,aAAaF,EAAQC,EAAO,aAE/C,SAAS,KAAK,YAAYD,CAAM,CAEpC,CAAC,CACH,CAKA,eAAeG,EAAiBC,EAAc,GAAIC,EAAU,IAAuB,CACjF,QAAS,EAAI,EAAG,EAAID,EAAa,IAAK,CACpC,GAAI,OAAO,OAAW,KAClB,OAAQ,OAAe,WAAe,KACtC,OAAQ,OAAe,WAAW,OAAU,WAC9C,MAAO,GAET,MAAM,IAAI,QAAQN,GAAW,WAAWA,EAASO,CAAO,CAAC,CAC3D,CACA,MAAO,EACT,CAEA,eAAeC,GAA8B,CAC3C,GAAI,SAAO,OAAW,KAAeb,IAAa,MAIlD,GAAI,CAIF,GAFAC,EAAmB,MAAMa,EAAe,oBAAoB,EAExD,CAACb,EAAkB,CACrB,QAAQ,KAAK,oDAAoD,EACjE,MACF,CAWA,GATA,QAAQ,IAAI,0DAA0D,EAGtE,MAAME,EAAoBF,CAAgB,EAG1C,QAAQ,IAAI,yCAAyC,EAGjD,CAFmB,MAAMS,EAAA,EAER,CACnB,QAAQ,KAAK,6CAA6C,EAC1D,MACF,CAEA,QAAQ,IAAI,oBAAoB,EAEhCV,EAAWe,EAAmBnB,EAAK,CACjC,SAAU,IAAIoB,EAAoBf,CAAgB,EAClD,0BAA2B,EAAA,CAC5B,EACD,QAAQ,IAAI,qDAAqD,CACnE,OAASgB,EAAO,CACd,QAAQ,KAAK,gCAAiCA,CAAK,CACrD,CACF,CAGA,IAAIC,EAAoC,KACpCC,EAAoB,GAKxB,eAAeC,GAAkC,CAC/C,GAAI,EAAAD,GAAqB,OAAO,OAAW,KAI3C,GAAI,CAEF,GAAI,CADc,MAAME,EAAA,EACR,CACd,QAAQ,KAAK,oDAAoD,EACjE,MACF,CAEAH,EAAeI,EAAgB1B,CAAG,EAIlCsB,EAAa,cAAgB,CAC3B,oBAAqB,GACrB,kBAAmB,GACnB,WAAY,GACZ,eAAgB,GAChB,mBAAoB,EAAA,EAItBA,EAAa,SAAW,CACtB,2BAAoE,KACpE,mBAAoB,GAAA,EAItB,MAAMK,EAAiBL,CAAY,EACnCC,EAAoB,GACpB,QAAQ,IAAI,mDAAmD,CACjE,OAASF,EAAO,CACd,QAAQ,KAAK,4CAA6CA,CAAK,EAC/D,QAAQ,IAAI,sCAAsC,CACpD,CACF,CAOA,eAAsBH,EAAeU,EAA8B,CAE5DL,GACH,MAAMC,EAAA,EAGR,GAAI,CACF,GAAIF,EAEF,OADcO,EAASP,EAAcM,CAAG,EAC3B,SAAA,CAEjB,OAASP,EAAO,CACd,QAAQ,KAAK,8BAA8BO,CAAG,KAAMP,CAAK,CAC3D,CAGA,eAAQ,KAAK,kBAAkBO,CAAG,oCAAoC,EAC/D,EACT,CAMA,eAAsBE,GAAwC,CAC5D,GAAI,CAIF,OAHKR,GACH,MAAME,EAAA,EAEJF,GACF,MAAMK,EAAiBL,CAAY,EACnC,QAAQ,IAAI,4BAA4B,EACjC,IAEF,EACT,OAASD,EAAO,CACd,eAAQ,MAAM,kCAAmCA,CAAK,EAC/C,EACT,CACF,CAKO,SAASU,GAA4B,CAC1C,OAAO3B,IAAa,IACtB,CAMI,OAAO,OAAW,KACpBoB,EAAA,EACG,KAAK,IAEGP,EAAA,CACR,EACA,MAAMe,GAAO,CACZ,QAAQ,MAAM,yCAA0CA,CAAG,CAC7D,CAAC"}