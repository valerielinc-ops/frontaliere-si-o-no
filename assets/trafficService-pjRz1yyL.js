import{r as S}from"./recaptchaService-BPXl6w1g.js";import{g as A}from"./index-BZ7LQtDa.js";import{b as K}from"./borderCrossings-CQBmICU_.js";const p=K.filter(r=>r.trafficLevel!=="closed").map(r=>({name:r.name,lat:r.lat,lng:r.lng,checkpointLat:r.lat+.01,checkpointLng:r.lng}));class I{constructor(){this.apiKey=null,this.cache=new Map,this.CACHE_DURATION=3600*1e3,this.distanceMatrixService=null,this.mapsLoaded=!1,this.mapsLoadPromise=null,this.apiKeyInitialized=!1,this.initApiKey()}async initApiKey(){if(!this.apiKeyInitialized)try{this.apiKey=await A("GOOGLE_MAPS_API_KEY"),this.apiKeyInitialized=!0,this.hasApiKey()&&(console.log("✅ Google Maps API key caricata da Firebase Remote Config"),await this.loadGoogleMaps())}catch(e){console.warn("⚠️ Errore caricamento API key da Firebase:",e),this.apiKey=null,this.apiKeyInitialized=!0}}loadGoogleMaps(){return this.mapsLoadPromise?this.mapsLoadPromise:(this.mapsLoadPromise=new Promise(e=>{if(typeof google<"u"&&google.maps&&google.maps.DistanceMatrixService){this.distanceMatrixService=new google.maps.DistanceMatrixService,this.mapsLoaded=!0,e();return}const t=document.createElement("script");t.src=`https://maps.googleapis.com/maps/api/js?key=${this.apiKey}&libraries=routes`,t.async=!0,t.defer=!0,t.onload=()=>{try{typeof google<"u"&&google.maps&&google.maps.DistanceMatrixService&&(this.distanceMatrixService=new google.maps.DistanceMatrixService,console.log("✅ Google Maps DistanceMatrixService initialized")),this.mapsLoaded=!0}catch(a){console.error("Failed to initialize Google Maps:",a)}e()},t.onerror=()=>{console.error("Failed to load Google Maps API"),e()},document.head.appendChild(t)}),this.mapsLoadPromise)}setApiKey(e){this.apiKey=e}hasApiKey(){return this.apiKey!==null&&this.apiKey!==""}async getTrafficData(){if(await this.initApiKey(),await S.canProceed("TRAFFIC_DATA"),!this.hasApiKey())return console.warn("Google Maps API key not configured. Using mock data."),this.getMockTrafficData();try{const e=p.map(a=>this.getTrafficForCrossing(a));return(await Promise.allSettled(e)).map((a,i)=>a.status==="fulfilled"?a.value:(console.error(`Error fetching traffic for ${p[i].name}:`,a.reason),this.getMockTrafficForCrossing(p[i].name)))}catch(e){return console.error("Error fetching traffic data:",e),this.getMockTrafficData()}}async getTrafficForCrossing(e){var i,s;const t=e.name,a=this.cache.get(t);if(a&&Date.now()-a.timestamp<this.CACHE_DURATION)return a.data;if(this.hasApiKey()&&!this.mapsLoaded&&await this.loadGoogleMaps(),!this.distanceMatrixService)return this.getMockTrafficForCrossing(e.name);try{const n=new google.maps.LatLng(e.lat,e.lng),c=new google.maps.LatLng(e.checkpointLat,e.checkpointLng),o=(i=(await new Promise((D,C)=>{this.distanceMatrixService.getDistanceMatrix({origins:[n],destinations:[c],travelMode:google.maps.TravelMode.DRIVING,drivingOptions:{departureTime:new Date,trafficModel:google.maps.TrafficModel.BEST_GUESS},unitSystem:google.maps.UnitSystem.METRIC},(m,y)=>{y==="OK"&&m?D(m):C(new Error(`Distance Matrix API error: ${y}`))})})).rows[0])==null?void 0:i.elements[0];if(!o||o.status!=="OK")throw new Error(`Route error: ${(o==null?void 0:o.status)||"NO_DATA"}`);const M=((s=o.duration_in_traffic)==null?void 0:s.value)||o.duration.value,w=o.duration.value,T=M-w,g=Math.max(0,Math.round(T/60));let f;g<5?f="green":g<15?f="yellow":f="red";const d=new Date().getHours();let h;d>=6&&d<10?h="IT → CH":d>=16&&d<20?h="CH → IT":h="Entrambi";const u={crossingName:e.name,waitTimeMinutes:g,status:f,direction:h,lastUpdate:new Date,source:"google-maps"};return this.cache.set(t,{data:u,timestamp:Date.now()}),u}catch(n){return console.error(`Error fetching traffic for ${e.name}:`,n),this.getMockTrafficForCrossing(e.name)}}getMockTrafficData(){return p.map(e=>this.getMockTrafficForCrossing(e.name))}getMockTrafficForCrossing(e){const t=new Date().getHours(),a=new Date().getDay();let i=3,s="Entrambi";e.includes("Chiasso")&&(i=8),(e.includes("Gaggiolo")||e.includes("Brogeda"))&&(i=6),(e.includes("Ponte Tresa")||e.includes("San Pietro")||e.includes("Luino"))&&(i=5),t>=7&&t<9&&(i*=e.includes("Chiasso")?3:2,s="IT → CH"),t>=17&&t<19&&(i*=e.includes("Chiasso")?4:2.5,s="CH → IT"),a===5&&t>=16&&(i*=1.5),a===0&&t>=17&&(i*=1.3);const n=.7+Math.random()*.6,c=Math.round(i*n);let l;return c<5?l="green":c<15?l="yellow":l="red",{crossingName:e,waitTimeMinutes:c,status:l,direction:s,lastUpdate:new Date,source:"mock"}}clearCache(){this.cache.clear()}}const P=new I;export{P as t};
//# sourceMappingURL=trafficService-pjRz1yyL.js.map
