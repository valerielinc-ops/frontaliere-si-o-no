{"version":3,"file":"firestoreService-rwgdI803.js","sources":["../../services/authService.ts","../../services/firestoreService.ts"],"sourcesContent":["/**\n * Firebase Authentication Service\n * Google Sign-In per Dashboard e Forum\n */\n\nimport { useState, useEffect, useCallback } from 'react';\nimport {\n  getAuth,\n  GoogleAuthProvider,\n  signInWithPopup,\n  signInWithRedirect,\n  getRedirectResult,\n  signOut as firebaseSignOut,\n  onAuthStateChanged,\n  User,\n  Auth,\n} from 'firebase/auth';\nimport { app } from '@/services/firebase';\nimport { Analytics } from '@/services/analytics';\n\n// ─── Firebase Auth Init ──────────────────────────────────────\n\nlet auth: Auth | null = null;\n\nfunction getAuthInstance(): Auth {\n  if (!auth) {\n    auth = getAuth(app);\n  }\n  return auth;\n}\n\nconst googleProvider = new GoogleAuthProvider();\ngoogleProvider.setCustomParameters({ prompt: 'select_account' });\n\n// ─── Auth Functions ──────────────────────────────────────────\n\nexport async function signInWithGoogle(): Promise<User | null> {\n  try {\n    const authInstance = getAuthInstance();\n    // Try popup first, fall back to redirect if COOP blocks it\n    try {\n      const result = await signInWithPopup(authInstance, googleProvider);\n      Analytics.trackUIInteraction('auth', 'google', 'login', 'success');\n      return result.user;\n    } catch (popupError: any) {\n      // COOP or popup blocked — fall back to redirect flow\n      if (\n        popupError?.code === 'auth/popup-blocked' ||\n        popupError?.code === 'auth/popup-closed-by-user' ||\n        popupError?.message?.includes('Cross-Origin-Opener-Policy')\n      ) {\n        await signInWithRedirect(authInstance, googleProvider);\n        return null; // redirect navigates away, result handled on return\n      }\n      throw popupError;\n    }\n  } catch (error: any) {\n    if (error?.code !== 'auth/popup-closed-by-user') {\n      console.warn('Google sign-in error:', error);\n      Analytics.trackUIInteraction('auth', 'google', 'login', 'error');\n    }\n    return null;\n  }\n}\n\nexport async function signOut(): Promise<void> {\n  try {\n    const authInstance = getAuthInstance();\n    await firebaseSignOut(authInstance);\n    Analytics.trackUIInteraction('auth', 'google', 'logout', 'success');\n  } catch (error) {\n    console.warn('Sign-out error:', error);\n  }\n}\n\n// ─── Auth Hook ───────────────────────────────────────────────\n\nexport interface AuthState {\n  user: User | null;\n  loading: boolean;\n}\n\nexport function useAuth(): AuthState & {\n  signIn: () => Promise<User | null>;\n  logout: () => Promise<void>;\n} {\n  const [user, setUser] = useState<User | null>(null);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    const authInstance = getAuthInstance();\n    // Handle redirect result (from signInWithRedirect fallback)\n    getRedirectResult(authInstance).then((result) => {\n      if (result?.user) {\n        Analytics.trackUIInteraction('auth', 'google', 'login', 'success-redirect');\n      }\n    }).catch(() => { /* redirect result may not exist — that's fine */ });\n\n    const unsubscribe = onAuthStateChanged(authInstance, (u) => {\n      setUser(u);\n      setLoading(false);\n    });\n    return unsubscribe;\n  }, []);\n\n  const signIn = useCallback(async () => {\n    return signInWithGoogle();\n  }, []);\n\n  const logout = useCallback(async () => {\n    return signOut();\n  }, []);\n\n  return { user, loading, signIn, logout };\n}\n\n/**\n * Get current user display info\n */\nexport function getUserDisplayName(user: User | null): string {\n  if (!user) return '';\n  return user.displayName || user.email?.split('@')[0] || 'Utente';\n}\n\nexport function getUserPhotoURL(user: User | null): string | null {\n  return user?.photoURL || null;\n}\n","/**\n * Firestore Service\n * Cloud persistence for Dashboard simulations and Forum Q&A\n */\n\nimport {\n  getFirestore,\n  collection,\n  doc,\n  getDocs,\n  getDoc,\n  addDoc,\n  updateDoc,\n  deleteDoc,\n  query,\n  where,\n  orderBy,\n  limit,\n  increment,\n  serverTimestamp,\n  Timestamp,\n  Firestore,\n} from 'firebase/firestore';\nimport { app } from '@/services/firebase';\nimport { SimulationInputs, SimulationResult } from '@/types';\n\n// ─── Firestore Init ──────────────────────────────────────────\n\nlet db: Firestore | null = null;\n\nfunction getDb(): Firestore {\n  if (!db) {\n    db = getFirestore(app);\n  }\n  return db;\n}\n\n// ─── Dashboard: Saved Simulations ────────────────────────────\n\nexport interface CloudSimulation {\n  id: string;\n  userId: string;\n  date: string;\n  label: string;\n  inputs: SimulationInputs;\n  result: SimulationResult;\n  createdAt?: any;\n}\n\nexport async function saveSimulationToCloud(\n  userId: string,\n  sim: { date: string; label: string; inputs: SimulationInputs; result: SimulationResult }\n): Promise<string> {\n  const db = getDb();\n  const ref = await addDoc(collection(db, 'simulations'), {\n    userId,\n    date: sim.date,\n    label: sim.label,\n    inputs: sim.inputs,\n    result: sim.result,\n    createdAt: serverTimestamp(),\n  });\n  return ref.id;\n}\n\nexport async function loadSimulationsFromCloud(userId: string): Promise<CloudSimulation[]> {\n  const db = getDb();\n  const q = query(\n    collection(db, 'simulations'),\n    where('userId', '==', userId),\n    orderBy('createdAt', 'desc'),\n    limit(50)\n  );\n  const snap = await getDocs(q);\n  return snap.docs.map(d => ({ id: d.id, ...d.data() } as CloudSimulation));\n}\n\nexport async function deleteSimulationFromCloud(simId: string): Promise<void> {\n  const db = getDb();\n  await deleteDoc(doc(db, 'simulations', simId));\n}\n\n// ─── Forum: Questions & Answers ──────────────────────────────\n\nexport interface ForumQuestion {\n  id: string;\n  title: string;\n  body: string;\n  authorId: string;\n  authorName: string;\n  authorPhoto: string | null;\n  category: string;\n  tags: string[];\n  upvotes: number;\n  upvotedBy: string[];\n  answerCount: number;\n  createdAt: Timestamp | null;\n  updatedAt: Timestamp | null;\n}\n\nexport interface ForumAnswer {\n  id: string;\n  questionId: string;\n  body: string;\n  authorId: string;\n  authorName: string;\n  authorPhoto: string | null;\n  upvotes: number;\n  upvotedBy: string[];\n  accepted: boolean;\n  createdAt: Timestamp | null;\n}\n\nexport const FORUM_CATEGORIES = [\n  'fiscalita',       // Fisco e Tasse\n  'permessi',        // Permessi di Lavoro\n  'assicurazioni',   // Assicurazioni (LAMal, Malattia)\n  'pensione',        // AVS, LPP, Pensione\n  'trasporti',       // Trasporti e Valichi\n  'residenza',       // Residenza e Trasloco\n  'lavoro',          // Lavoro e Contratti\n  'famiglia',        // Famiglia e Figli\n  'generale',        // Generale\n] as const;\n\nexport type ForumCategory = typeof FORUM_CATEGORIES[number];\n\n// ─── Forum: Question CRUD ────────────────────────────────────\n\nexport async function createQuestion(data: {\n  title: string;\n  body: string;\n  authorId: string;\n  authorName: string;\n  authorPhoto: string | null;\n  category: ForumCategory;\n  tags: string[];\n}): Promise<string> {\n  const db = getDb();\n  const ref = await addDoc(collection(db, 'forum_questions'), {\n    ...data,\n    upvotes: 0,\n    upvotedBy: [],\n    answerCount: 0,\n    createdAt: serverTimestamp(),\n    updatedAt: serverTimestamp(),\n  });\n  return ref.id;\n}\n\nexport async function getQuestions(opts?: {\n  category?: ForumCategory;\n  sortBy?: 'recent' | 'popular';\n  maxResults?: number;\n}): Promise<ForumQuestion[]> {\n  const db = getDb();\n  const constraints: any[] = [];\n\n  if (opts?.category) {\n    constraints.push(where('category', '==', opts.category));\n  }\n\n  if (opts?.sortBy === 'popular') {\n    constraints.push(orderBy('upvotes', 'desc'));\n  } else {\n    constraints.push(orderBy('createdAt', 'desc'));\n  }\n\n  constraints.push(limit(opts?.maxResults || 30));\n\n  const q = query(collection(db, 'forum_questions'), ...constraints);\n  const snap = await getDocs(q);\n  return snap.docs.map(d => ({ id: d.id, ...d.data() } as ForumQuestion));\n}\n\nexport async function getQuestion(questionId: string): Promise<ForumQuestion | null> {\n  const db = getDb();\n  const snap = await getDoc(doc(db, 'forum_questions', questionId));\n  if (!snap.exists()) return null;\n  return { id: snap.id, ...snap.data() } as ForumQuestion;\n}\n\nexport async function upvoteQuestion(questionId: string, userId: string): Promise<void> {\n  const db = getDb();\n  const ref = doc(db, 'forum_questions', questionId);\n  const snap = await getDoc(ref);\n  if (!snap.exists()) return;\n\n  const data = snap.data();\n  const already = (data.upvotedBy || []).includes(userId);\n\n  if (already) {\n    // Remove upvote\n    await updateDoc(ref, {\n      upvotes: increment(-1),\n      upvotedBy: (data.upvotedBy || []).filter((id: string) => id !== userId),\n    });\n  } else {\n    // Add upvote\n    await updateDoc(ref, {\n      upvotes: increment(1),\n      upvotedBy: [...(data.upvotedBy || []), userId],\n    });\n  }\n}\n\n// ─── Forum: Answer CRUD ──────────────────────────────────────\n\nexport async function createAnswer(data: {\n  questionId: string;\n  body: string;\n  authorId: string;\n  authorName: string;\n  authorPhoto: string | null;\n}): Promise<string> {\n  const db = getDb();\n  const ref = await addDoc(collection(db, 'forum_answers'), {\n    ...data,\n    upvotes: 0,\n    upvotedBy: [],\n    accepted: false,\n    createdAt: serverTimestamp(),\n  });\n\n  // Increment answer count on question\n  const qRef = doc(db, 'forum_questions', data.questionId);\n  await updateDoc(qRef, {\n    answerCount: increment(1),\n    updatedAt: serverTimestamp(),\n  });\n\n  return ref.id;\n}\n\nexport async function getAnswers(questionId: string): Promise<ForumAnswer[]> {\n  const db = getDb();\n  const q = query(\n    collection(db, 'forum_answers'),\n    where('questionId', '==', questionId),\n    orderBy('createdAt', 'asc'),\n    limit(100)\n  );\n  const snap = await getDocs(q);\n  return snap.docs.map(d => ({ id: d.id, ...d.data() } as ForumAnswer));\n}\n\nexport async function upvoteAnswer(answerId: string, userId: string): Promise<void> {\n  const db = getDb();\n  const ref = doc(db, 'forum_answers', answerId);\n  const snap = await getDoc(ref);\n  if (!snap.exists()) return;\n\n  const data = snap.data();\n  const already = (data.upvotedBy || []).includes(userId);\n\n  if (already) {\n    await updateDoc(ref, {\n      upvotes: increment(-1),\n      upvotedBy: (data.upvotedBy || []).filter((id: string) => id !== userId),\n    });\n  } else {\n    await updateDoc(ref, {\n      upvotes: increment(1),\n      upvotedBy: [...(data.upvotedBy || []), userId],\n    });\n  }\n}\n\nexport async function acceptAnswer(answerId: string): Promise<void> {\n  const db = getDb();\n  await updateDoc(doc(db, 'forum_answers', answerId), { accepted: true });\n}\n"],"names":["auth","getAuthInstance","getAuth","app","googleProvider","GoogleAuthProvider","signInWithGoogle","authInstance","result","signInWithPopup","Analytics","popupError","_a","signInWithRedirect","error","signOut","firebaseSignOut","useAuth","user","setUser","useState","loading","setLoading","useEffect","getRedirectResult","onAuthStateChanged","signIn","useCallback","logout","getUserDisplayName","getUserPhotoURL","db","getDb","getFirestore","saveSimulationToCloud","userId","sim","addDoc","collection","serverTimestamp","loadSimulationsFromCloud","q","query","where","orderBy","limit","getDocs","d","deleteSimulationFromCloud","simId","deleteDoc","doc","FORUM_CATEGORIES","createQuestion","data","getQuestions","opts","constraints","upvoteQuestion","questionId","ref","snap","getDoc","updateDoc","increment","id","createAnswer","qRef","getAnswers","upvoteAnswer","answerId"],"mappings":"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"}